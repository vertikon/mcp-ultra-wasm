SHELL := /bin/bash
GOLANGCI ?= golangci-lint
VETTOOL  := $(PWD)/vettools/depguard-lite

.PHONY: help tidy verify lint lint-new vettool vet-dep test coverage-html mocks build ci

help:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "   Makefile do mcp-ultra-wasm - Blueprint Depguard-Lite"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“¦ Gerenciamento de MÃ³dulos:"
	@echo "  tidy       - Executa go mod tidy"
	@echo "  verify     - Executa go mod verify"
	@echo ""
	@echo "ğŸ” Linting:"
	@echo "  lint       - golangci-lint com depguard (configuraÃ§Ã£o antiga)"
	@echo "  lint-new   - golangci-lint com gomodguard (nova configuraÃ§Ã£o)"
	@echo "  vettool    - Compila depguard-lite (vettool nativo Go)"
	@echo "  vet-dep    - go vet com depguard-lite"
	@echo ""
	@echo "ğŸ§ª Testes:"
	@echo "  test       - Executa testes"
	@echo "  coverage-html - Gera relatÃ³rio HTML de cobertura"
	@echo "  mocks      - Regenera mocks"
	@echo ""
	@echo "ğŸ—ï¸  Build:"
	@echo "  build      - Compila o projeto"
	@echo ""
	@echo "ğŸš€ CI:"
	@echo "  ci         - Pipeline completo (tidy + verify + lint-new + vet-dep + test)"

tidy:
	@echo "ğŸ“¦ Executando go mod tidy..."
	go mod tidy

verify:
	@echo "âœ“ Verificando go.sum..."
	go mod verify

# Lint com configuraÃ§Ã£o antiga (depguard)
lint:
	@echo "ğŸ” Executando golangci-lint (configuraÃ§Ã£o antiga)..."
	$(GOLANGCI) run --timeout=5m

# Lint com nova configuraÃ§Ã£o (gomodguard)
lint-new: tidy verify
	@echo "ğŸ” Executando golangci-lint (nova configuraÃ§Ã£o com gomodguard)..."
	$(GOLANGCI) run --config=.golangci-new.yml --timeout=5m

# Compila o vettool depguard-lite
vettool:
	@echo "ğŸ”¨ Compilando depguard-lite..."
	@mkdir -p vettools
	go build -o vettools/depguard-lite ./cmd/depguard-lite
	@echo "âœ… Vettool compilado em vettools/depguard-lite"

# Executa go vet com depguard-lite
vet-dep: vettool
	@echo "ğŸ” Executando go vet com depguard-lite..."
	go vet -vettool=$(VETTOOL) ./...

# Testes
test:
	@echo "ğŸ§ª Executando testes..."
	go test ./... -v -count=1

# Coverage HTML
coverage-html:
	@echo "ğŸ“Š Gerando relatÃ³rio de cobertura..."
	go test ./... -coverprofile=coverage.out
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage HTML gerado em coverage.html"

# Mocks
mocks:
	@echo "ğŸ”„ Regenerando mocks..."
	bash scripts/regenerate_mocks.sh

# Build
build:
	@echo "ğŸ—ï¸  Compilando projeto..."
	go build -o bin/mcp-ultra-wasm ./cmd/...

# Pipeline de CI completo
ci: tidy verify lint-new test vet-dep
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "   âœ… CI COMPLETO - Todas as verificaÃ§Ãµes passaram"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
